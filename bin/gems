#!/usr/bin/env ruby
require 'gli'

include GLI::App

program_desc 'Interact with Rubygems.org from the command line'

version GemsCli::VERSION

# Use argument validation
arguments :strict

desc 'Search Rubygems.org for a gem'
arg_name 'Name of a gem'
command [:search, :s] do |c|
  c.desc 'Feeling lucky, punk?'
  c.switch [:l, :lucky]

  c.desc 'Number of results returned'
  c.default_value 10
  c.flag :n

  c.action do |global_options,options,args|

    # raise "that command made no sense"
    if args[0].nil? || args[0].empty?
      raise ArgumentError, 'Please supply a search term.'
    end

    result_limit = options[:l] ? 0 : options[:n].to_i

    puts "Running your search for #{args[0]}...".color(:green)
    search_results = Gems.search args[0]
    iteration = 0
    search_results[0..result_limit].each do |result|
      puts "#{iteration}: gem '#{result['name']}', '~> #{result['version']}'"
      iteration += 1
    end
    choices = "select from 0..#{search_results.size - 1} or (q)uit \n".color(:green)
    answer = ask(choices, String) do |q|
               q.case      = :downcase
               q.validate  = /\A\d|q\Z/
             end

    case answer
    when /\d/
      if search_results[answer.to_i]
        Clipboard.copy "gem '#{search_results[answer.to_i]['name']}', '~> #{search_results[answer.to_i]['version']}'"
        puts "Copied to clipboard!".color(:green)
      else
        puts "Your choice, #{answer}, is not in the list 0..#{search_results.size - 1}"
      end
    when 'q'
      puts 'Later.'
    else
      puts "Sorry. Unknown option: #{answer.chomp}"
    end
  end
end

pre do |global,command,options,args|
  # Pre logic here
  # Return true to proceed; false to abort and not call the
  # chosen command
  # Use skips_pre before a command to skip this block
  # on that command only
  true
end

post do |global,command,options,args|
  # Post logic here
  # Use skips_post before a command to skip this
  # block on that command only
end

on_error do |exception|
  # Error logic here
  # return false to skip default error handling
  true
end

exit run(ARGV)
